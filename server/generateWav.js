const C = require('construct-js');
const fs = require('fs');
const path = require('path');

const generateWav = function () {
	//this will be the array for wave
	//WAV FILE GENERATION:
	const riffChunkStruct = C.Struct('riffChunk')
		.field('magic', C.RawString('RIFF'))
		.field('size', C.U32(0))
		.field('fmtName', C.RawString('WAVE'));

	const fmtSubChunkStruct = C.Struct('fmtSubChunk')
		.field('id', C.RawString('fmt '))
		.field('subChunk1Size', C.U32(0))
		.field('audioFormat', C.U16(1))
		.field('numChannels', C.U16(1))
		.field('sampleRate', C.U32(8000))
		.field('byteRate', C.U32(8000 * 2))
		.field('blockAlign', C.U16(2))
		.field('bitPerSample', C.U16(16));

	const totalSUbChunkSize = fmtSubChunkStruct.computeBufferSize();
	fmtSubChunkStruct.get('subChunk1Size').set(totalSUbChunkSize - 8);

	const dataSubChunkStruct = C.Struct('dataSubChunk')
		.field('id', C.RawString('data'))
		.field('size', C.U32(0))
		.field('data', C.I16s([0]));

	//this will be the array for wave
	let rawData = [
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 4, 2, 1, 0,
		1, 0, 0, 0, 0, 1, 1, 3, 4, 2, 0, 0, 1, 0, 0, 0, 0, 2, 1, 1, 0, 0, 2, 5, 3,
		1, 5, 8, 0, 4, 4, 8, 5, 4, 9, 18, 34, 51, 70, 77, 125, 143, 206, 384, 476,
		472, 665, 799, 864, 1542, 1723, 2179, 2769, 3656, 4568, 5437, 6844, 8047,
		8813, 10507, 14048, 15319, 15734, 21188, 11761, 20131, 22232, 24432, 26234,
		26640, 21246, 24590, 25313, 27732, 28619, 26948, 26861, 22503, 21117, 22123,
		21812, 27478, 26331, 24061, 23331, 23865, 22868, 27335, 29956, 31456, 29918,
		24039, 22376, 22712, 24725, 28654, 29663, 26247, 24824, 20424, 22079, 23888,
		27807, 26657, 24663, 20547, 19045, 23664, 16219, 33237, 25448, 24650, 19084,
		22502, 21331, 23125, 24776, 24889, 20100, 20591, 19063, 16342, 19307, 23117,
		22958, 23395, 20610, 16889, 20572, 20323, 20040, 24183, 23179, 17328, 17820,
		18373, 21771, 22581, 28055, 26042, 20106, 20452, 24593, 25488, 28194, 32868,
		32982, 26882, 28572, 37702, 36883, 46854, 46226, 43205, 37244, 38486, 46496,
		58951, 55197, 60022, 49269, 39919, 50988, 56732, 64318, 61889, 68207, 68224,
		58588, 55950, 64754, 71955, 69238, 76692, 67006, 59745, 58443, 63402, 72107,
		73355, 73181, 61170, 58195, 53385, 58897, 64548, 66478, 68412, 56212, 51229,
		45242, 51750, 55715, 54600, 61885, 51351, 46317, 44088, 58824, 54839, 51764,
		55827, 51304, 41662, 41689, 41531, 46803, 46502, 47375, 41542, 36850, 36011,
		40696, 46970, 46790, 46689, 40683, 36361, 39130, 39014, 41978, 45147, 50962,
		41197, 33446, 24901, 28436, 35061, 38345, 44067, 39816, 32682, 34436, 36884,
		44308, 45054, 47746, 42061, 33955, 41542, 49864, 42172, 45863, 49590, 42327,
		34752, 38920, 38515, 45516, 46763, 50488, 47337, 34944, 41441, 41558, 53447,
		55019, 58518, 53423, 44174, 49702, 50249, 57480, 62451, 68708, 54012, 48485,
		61603, 58551, 69446, 74272, 82126, 75612, 65177, 69434, 75459, 84203, 90632,
		97033, 92551, 73430, 86955, 98165, 113706, 122546, 132983, 127979, 110475,
		124089, 146588, 152169, 160816, 176134, 162420, 137643, 151744, 166507,
		169368, 188079, 192613, 172087, 148990, 158285, 174294, 192850, 142270,
		162828, 143346, 138475, 150304, 190999, 206660, 214414, 222120, 202826,
		174081, 181325, 225618, 218172, 205111, 243390, 212758, 177830, 195630,
		197440, 237037, 242528, 233736, 200308, 183359, 180485, 196107, 221580,
		197846, 154938, 146250, 153183, 174073, 205461, 231200, 224032, 221574,
		222799, 202549, 169966, 239346, 251544, 262724, 286196, 249420, 218491,
		199816, 213843, 221017, 217250, 233727, 206865, 178458, 147277, 145943,
		182351, 182141, 184979, 158796, 138475, 130008, 142947, 152261, 150434,
		158536, 131846, 107855, 125369, 118063, 107328, 121745, 118717, 102755,
		86652, 78485, 89114, 93554, 94695, 92969, 80459, 62598, 55389, 54769, 60394,
		63847, 69225, 63246, 51712, 53074, 67536, 68174, 67307, 69107, 64199, 47877,
		48619, 51165, 61123, 61375, 59910, 53464, 39828, 40689, 50254, 57565, 55850,
		59922, 48190, 43316, 40750, 49196, 56235, 58696, 58003, 54447, 41317, 45529,
		55098, 63279, 61667, 70589, 58296, 49002, 55436, 59290, 66126, 70053, 66923,
		60131, 42263, 54394, 62163, 71826, 72548, 73887, 65426, 51189, 59850, 69980,
		68537, 70220, 69304, 75602, 47624, 34355, 56343, 61861, 60436, 61134, 50522,
		39812, 38757, 49580, 53539, 54760, 54058, 47264, 35625, 32551, 42018, 43906,
		42232, 43909, 36077, 26620, 24187, 32697, 35281, 39804, 34806, 29077, 20865,
		19212, 27463, 27233, 27472, 27608, 21757, 15535, 15073, 24144, 23250, 21785,
		24498, 15334, 12081, 9167, 8966, 16101, 17935, 18437, 14512, 10734, 9750,
		13965, 19215, 15470, 13920, 12206, 8592, 8173, 12652, 12987, 13281, 11774,
		12226, 8941, 8594, 13272, 13652, 15383, 14916, 13048, 10450, 10438, 15471,
		11477, 18439, 16776, 13038, 10322, 9135, 19964, 22225, 27316, 27292, 20450,
		16276, 28873, 34664, 38040, 40039, 41855, 31693, 27713, 44322, 50435, 60702,
		70739, 68749, 53006, 42557, 70487, 84947, 88104, 98319, 103739, 79816,
		60585, 101086, 109035, 125815, 126878, 124915, 119136, 95837, 92338, 133152,
		142487, 150201, 145336, 138677, 109448, 107906, 148629, 165467, 173806,
		165027, 143172, 126122, 114884, 161519, 175875, 185096, 181236, 151486,
		117189, 131919, 175210, 197101, 181785, 180647, 143049, 124106, 108429,
		116663, 167791, 182519, 170173, 154853, 115504, 111269, 160429, 160964,
		165311, 156143, 123545, 96033, 90724, 131485, 131029, 134609, 131746, 96702,
		76184, 100360, 114644, 114927, 121042, 119761, 82266, 67106, 84775, 102267,
		105080, 111170, 106533, 70483, 58919, 73337, 88471, 94773, 94465, 89964,
		63301, 48641, 67518, 79071, 75051, 86408, 80826, 35845, 25695, 83219,
		101323, 82703, 81664, 85961, 34473, 25442, 107668, 73444, 77953, 87786,
		88555, 35669, 30023, 115455, 81782, 90971, 72425, 121418, 53940, 31830,
		132412, 96975, 103744, 111662, 113869, 46131, 34221, 143827, 99386, 106793,
		69132, 81762, 51871, 52403, 92596, 119062, 130739, 142230, 151867, 67401,
		48953, 181161, 123857, 126562, 134950, 134370, 64233, 49053, 181764, 118734,
		138980, 151663, 160892, 89395, 77879, 246896, 187686, 227703, 256022,
		241513, 133088, 155209, 422385, 360253, 455803, 557592, 469704, 303427,
		306948, 873703, 690348, 697481, 764809, 867858, 449198, 369858, 1235521,
		791928, 831735, 892398, 851859, 475180, 358114, 956196, 852152, 775345,
		767762, 778130, 334931, 291132, 1004031, 492973, 542492, 567678, 526276,
		224041, 151980, 571752, 296863, 303127, 349511, 268148, 105884, 93097,
		293776, 197003, 194149, 166484, 155554, 68978, 45559, 173739, 108373,
		105547, 98798, 103932, 41768, 29518, 47961, 115069, 73235, 74056, 75095,
		26249, 16373, 71582, 42000, 52348, 51202, 42787, 14713, 6983, 55164, 29794,
		45476, 38718, 36892, 12370, 7600, 37513, 23851, 37418, 32672, 30322, 10108,
		8023, 38317, 23681, 34662, 31838, 27804, 10044, 7565, 31942, 20755, 37177,
		33883, 27638, 10585, 7368, 26620, 31720, 41028, 31803, 42009, 14391, 12498,
		33669, 26112, 44359, 61413, 44069, 16824, 16906, 35261, 50912, 57626, 50242,
		70592, 27452, 19720, 50692, 62626, 76527, 62055, 86220, 31142, 24000, 62260,
		72070, 101032, 81307, 102585, 33151, 19133, 106748, 97352, 127097, 100763,
		121570, 33501, 43508, 114523, 124229, 145870, 112039, 157304, 41370, 36508,
		109747, 129960, 156271, 113176, 153263, 41366, 29437, 54643, 155168, 140135,
		111759, 146857, 52832, 37984, 98722, 148431, 148324, 106375, 151580, 40598,
		34158, 91329, 135405, 144115, 98452, 129200, 38723, 33420, 52054, 184839,
		132691, 104031, 167937, 48232, 37892, 95608, 152460, 148309, 113210, 172882,
		48823, 34778, 48084, 168055, 141238, 116359, 177420, 54610, 45957, 118913,
		181486, 152779, 137454, 187924, 55219, 45192, 105796, 174565, 157933,
		146939, 185062, 52999, 44372, 110320, 165322, 158900, 143344, 170478, 37736,
		29472, 123284, 157192, 148668, 132013, 153049, 33459, 26739, 103436, 133815,
		137249, 125313, 139100, 30823, 21349, 96180, 124289, 119235, 113589, 128421,
		27009, 21653, 85282, 113367, 129358, 110591, 114419, 28010, 20521, 85037,
		113715, 119296, 103514, 107155, 23473, 18516, 25041, 117514, 88923, 87686,
		81861, 19715, 16742, 60728, 54413, 83403,
	];

	console.log('MAX value', Math.max(...rawData));
	const maxData = Math.max(...rawData);
	const maxAmplitude = 30000; //actually 32767, conservitavely use 30K
	const compFactor = Math.round(maxData / maxAmplitude);
	console.log('Length: ', rawData.length);

	const soundData = [];
	// let isUp = true;
	// for (let i = 0; i < 44100; i++) {
	// 	if (i % 50 === 0) {
	// 		isUp = !isUp;
	// 	}
	// 	const sampleValue = isUp ? 16383 : -16383;
	// 	soundData[i] = sampleValue;
	// }
	for (let i = 0; i < rawData.length; i++) {
		const value = Math.round(rawData[i] / compFactor);
		soundData.push(value);
	}

	dataSubChunkStruct.get('data').set(soundData);
	dataSubChunkStruct.get('size').set(soundData.length * 2);

	const fileStruct = C.Struct('waveFile')
		.field('riffChunk', riffChunkStruct)
		.field('fmtSubChunk', fmtSubChunkStruct)
		.field('dataSubChunk', dataSubChunkStruct);

	fs.writeFileSync(
		path.join(__dirname, './new.wav'),
		fileStruct.toUint8Array()
	);
};

module.exports = {
	generateWav,
};
